<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评论后台管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .loader { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div id="app" class="min-h-screen flex flex-col">

    <transition name="fade">
        <div v-if="toast.show" :class="toast.type === 'error' ? 'bg-red-500' : 'bg-green-500'" 
             class="fixed top-4 right-4 text-white px-6 py-3 rounded shadow-lg z-50 flex items-center">
            <i :class="toast.type === 'error' ? 'fa-circle-exclamation' : 'fa-check-circle'" class="fa-solid mr-2"></i>
            {{ toast.message }}
        </div>
    </transition>

    <div v-if="!isLoggedIn" class="flex-1 flex items-center justify-center px-4">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-700">管理员登录</h2>
            
            <form @submit.prevent="handleLogin">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">接口地址 (API Base URL)</label>
                    <input v-model="config.baseUrl" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">用户名</label>
                    <input v-model="loginForm.name" type="text" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">密码</label>
                    <input v-model="loginForm.password" type="password" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <button :disabled="loading" type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-300 flex justify-center items-center">
                    <span v-if="loading" class="loader ease-linear rounded-full border-2 border-t-2 border-gray-200 h-5 w-5 mr-2"></span>
                    {{ loading ? '登录中...' : '登录' }}
                </button>
            </form>
        </div>
    </div>

    <div v-else class="flex-1 flex flex-col">
        <nav class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <span class="text-xl font-bold text-blue-600">评论管理系统</span>
                        <span class="ml-4 text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded">{{ config.baseUrl }}</span>
                    </div>
                    <div class="flex items-center">
                        <button @click="fetchComments(pagination.page)" class="mr-4 text-gray-600 hover:text-blue-600">
                            <i class="fa-solid fa-rotate-right"></i> 刷新
                        </button>
                        <button @click="logout" class="text-red-500 hover:text-red-700 font-medium">
                            <i class="fa-solid fa-sign-out-alt"></i> 退出
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <div v-if="loading && comments.length === 0" class="flex justify-center items-center h-64">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
            </div>

            <div v-else class="bg-white shadow overflow-hidden sm:rounded-lg">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">信息</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/2">内容</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr v-if="comments.length === 0">
                                <td colspan="4" class="px-6 py-10 text-center text-gray-500">暂无评论数据</td>
                            </tr>
                            <tr v-for="comment in comments" :key="comment.id" class="hover:bg-gray-50 transition">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div>
                                            <div class="text-sm font-medium text-gray-900">{{ comment.author }}</div>
                                            <div class="text-sm text-gray-500">{{ comment.email }}</div>
                                            <div class="text-xs text-gray-400 mt-1">{{ comment.ipAddress }}</div>
                                            <div class="text-xs text-gray-400">{{ formatDate(comment.pubDate) }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-gray-900 break-words whitespace-pre-wrap max-h-32 overflow-y-auto">{{ comment.contentText }}</div>
                                    <a v-if="comment.url" :href="comment.url" target="_blank" class="text-xs text-blue-500 hover:underline mt-1 inline-block">
                                        <i class="fa-solid fa-link"></i> 访问作者网站
                                    </a>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                          :class="{
                                              'bg-green-100 text-green-800': comment.status === 'approved',
                                              'bg-yellow-100 text-yellow-800': comment.status === 'pending',
                                              'bg-red-100 text-red-800': comment.status === 'spam' || comment.status === 'rejected'
                                          }">
                                        {{ comment.status }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <button v-if="comment.status !== 'approved'" @click="updateStatus(comment.id, 'approved')" class="text-green-600 hover:text-green-900 mr-3" title="通过">
                                        <i class="fa-solid fa-check"></i>
                                    </button>
                                    <button v-if="comment.status === 'approved'" @click="updateStatus(comment.id, 'pending')" class="text-yellow-600 hover:text-yellow-900 mr-3" title="设为待审">
                                        <i class="fa-solid fa-ban"></i>
                                    </button>
                                    
                                    <button @click="confirmDelete(comment.id)" class="text-red-600 hover:text-red-900" title="删除">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6" v-if="pagination.total > 0">
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                显示第 <span class="font-medium">{{ (pagination.page - 1) * pagination.limit + 1 }}</span> 到 <span class="font-medium">{{ Math.min(pagination.page * pagination.limit, pagination.total) }}</span> 条，
                                共 <span class="font-medium">{{ pagination.total }}</span> 条
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                                <button @click="changePage(pagination.page - 1)" :disabled="pagination.page === 1" 
                                    class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                    上一页
                                </button>
                                <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                                    {{ pagination.page }}
                                </span>
                                <button @click="changePage(pagination.page + 1)" :disabled="pagination.page * pagination.limit >= pagination.total"
                                    class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                    下一页
                                </button>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    const { createApp, reactive, toRefs, onMounted } = Vue;

    createApp({
        setup() {
            const state = reactive({
                isLoggedIn: false,
                loading: false,
                apiKey: '',
                config: {
                    // 这里可以修改默认后端地址
                    baseUrl: localStorage.getItem('apiBaseUrl') || 'https://api.motues.top' 
                },
                loginForm: {
                    name: '',
                    password: ''
                },
                comments: [],
                pagination: {
                    page: 1,
                    limit: 20,
                    total: 0
                },
                toast: {
                    show: false,
                    message: '',
                    type: 'success'
                }
            });

            // 工具：显示提示
            const showToast = (msg, type = 'success') => {
                state.toast.message = msg;
                state.toast.type = type;
                state.toast.show = true;
                setTimeout(() => state.toast.show = false, 3000);
            };

            // 工具：日期格式化
            const formatDate = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleString('zh-CN', { hour12: false });
            };

            // 1. 登录 (已修正逻辑)
            const handleLogin = async () => {
                state.loading = true;
                // 保存用户输入的API地址以备后用
                localStorage.setItem('apiBaseUrl', state.config.baseUrl);

                try {
                    const response = await fetch(`${state.config.baseUrl}/admin/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(state.loginForm)
                    });
                    
                    const resData = await response.json();

                    // 修正：兼容 resData.key 或 resData.data.key
                    const key = resData.key || (resData.data && resData.data.key);

                    if (key) {
                        state.apiKey = key;
                        state.isLoggedIn = true;
                        localStorage.setItem('adminKey', key);
                        showToast('登录成功');
                        fetchComments();
                    } else {
                        showToast(resData.message || '登录失败', 'error');
                    }
                } catch (error) {
                    showToast('网络错误: ' + error.message, 'error');
                } finally {
                    state.loading = false;
                }
            };

            // 2. 获取评论列表
            // 2. 获取评论列表 (修复版：增加数据结构容错)
            const fetchComments = async (page = 1) => {
                state.loading = true;
                try {
                    const url = `${state.config.baseUrl}/admin/comments/list?page=${page}&key=${state.apiKey}`;
                    
                    const response = await fetch(url);
                    const result = await response.json();
                    
                    // 在控制台打印数据，方便调试查看真实结构
                    console.log("后端返回的完整数据:", result);

                    // 处理 401 Key 无效
                    if (result.message === "Invalid key" || result.status === 401) {
                        logout();
                        showToast('登录已过期，请重新登录', 'error');
                        return;
                    }

                    // --- 核心修复部分开始 ---
                    
                    // 1. 尝试提取评论列表
                    // 兼容 result.data 是数组的情况，也兼容 result.data.data 是数组的情况
                    let listData = [];
                    if (Array.isArray(result.data)) {
                        listData = result.data;
                    } else if (result.data && Array.isArray(result.data.data)) {
                        listData = result.data.data; // 应对嵌套层级
                    } else if (result.data && Array.isArray(result.data.list)) {
                        listData = result.data.list; // 应对另一种常见命名
                    }

                    // 2. 尝试提取分页信息
                    // 优先取 result.pagination，没有的话取 result.data.pagination，还没有就造一个默认值
                    let pageData = result.pagination || (result.data && result.data.pagination);

                    // 如果后端完全没返回分页信息，使用默认值防止报错崩溃！
                    if (!pageData) {
                        console.warn("未找到分页信息，使用默认值");
                        pageData = {
                            page: page,
                            limit: 20,
                            total: listData.length // 如果没有总数，暂时用当前列表长度代替
                        };
                    }

                    // 安全赋值
                    state.comments = listData;
                    state.pagination = pageData;
                    
                    // --- 核心修复部分结束 ---

                } catch (error) {
                    console.error(error);
                    showToast('获取数据失败: ' + error.message, 'error');
                } finally {
                    state.loading = false;
                }
            };

            // 3. 修改状态
            const updateStatus = async (id, newStatus) => {
                state.loading = true;
                try {
                    // 构造 URL: /admin/comments/status?id=...&status=...&key=...
                    const url = `${state.config.baseUrl}/admin/comments/status?id=${id}&status=${newStatus}&key=${state.apiKey}`;
                    
                    const response = await fetch(url, { method: 'PUT' });
                    const result = await response.json();

                    if (response.ok || result.message) {
                        showToast(`状态更新成功 (ID: ${id})`);
                        // 局部更新，避免全屏刷新带来的闪烁
                        const comment = state.comments.find(c => c.id === id);
                        if(comment) comment.status = newStatus;
                    } else {
                        showToast('更新失败', 'error');
                    }
                } catch (error) {
                    showToast('网络请求失败', 'error');
                } finally {
                    state.loading = false;
                }
            };

            // 4. 删除评论
            const confirmDelete = async (id) => {
                if(!confirm('确定要删除这条评论吗？此操作不可恢复。')) return;

                state.loading = true;
                try {
                    // 构造 URL: /admin/comments/delete?id=...&key=...
                    const url = `${state.config.baseUrl}/admin/comments/delete?id=${id}&key=${state.apiKey}`;
                    
                    const response = await fetch(url, { method: 'DELETE' });
                    const result = await response.json();

                    if (response.ok || result.message) {
                        showToast('删除成功');
                        fetchComments(state.pagination.page); // 刷新列表
                    } else {
                        showToast('删除失败', 'error');
                    }
                } catch (error) {
                    showToast('网络请求失败', 'error');
                } finally {
                    state.loading = false;
                }
            };

            // 分页跳转
            const changePage = (page) => {
                if (page > 0) fetchComments(page);
            };

            // 退出登录
            const logout = () => {
                localStorage.removeItem('adminKey');
                state.apiKey = '';
                state.isLoggedIn = false;
                state.comments = [];
            };

            // 初始化检查
            onMounted(() => {
                const storedKey = localStorage.getItem('adminKey');
                if (storedKey) {
                    state.apiKey = storedKey;
                    state.isLoggedIn = true;
                    fetchComments();
                }
            });

            return {
                ...toRefs(state),
                handleLogin,
                fetchComments,
                updateStatus,
                confirmDelete,
                changePage,
                logout,
                formatDate
            };
        }
    }).mount('#app');
</script>
</body>
</html>