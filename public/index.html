<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评论系统测试界面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
        }
        input, textarea, button {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background-color: #0056b3;
        }
        .comment {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }
        .comment:last-child {
            border-bottom: none;
        }
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #666;
        }
        .comment-author {
            font-weight: bold;
        }
        .comment-content {
            margin: 10px 0;
        }
        .comment-form {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
        }
        #comments-container {
            max-height: 500px;
            overflow-y: auto;
        }
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        .error {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #388e3c;
            background-color: #e8f5e9;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>评论系统测试界面</h1>
        
        <div class="container">
            <h2>获取评论</h2>
            <div>
                <label for="post_slug">文章标识 (post_slug):</label>
                <input type="text" id="post_slug" value="test-post" placeholder="请输入文章标识">
            </div>
            <div>
                <label for="page">页码 (page):</label>
                <input type="number" id="page" value="1" min="1">
            </div>
            <div>
                <label for="limit">每页数量 (limit):</label>
                <input type="number" id="limit" value="20" min="1" max="100">
            </div>
            <div>
                <label>
                    <input type="checkbox" id="nested" checked> 嵌套显示评论
                </label>
            </div>
            <button id="fetch-comments">获取评论</button>
        </div>

        <div class="container">
            <h2>提交新评论</h2>
            <div class="comment-form">
                <div>
                    <label for="new_post_slug">文章标识 (post_slug):</label>
                    <input type="text" id="new_post_slug" value="test-post" placeholder="请输入文章标识">
                </div>
                <div>
                    <label for="author">姓名:</label>
                    <input type="text" id="author" placeholder="请输入您的姓名">
                </div>
                <div>
                    <label for="email">邮箱:</label>
                    <input type="email" id="email" placeholder="请输入您的邮箱">
                </div>
                <div>
                    <label for="url">网站 (可选):</label>
                    <input type="url" id="url" placeholder="https://example.com">
                </div>
                <div>
                    <label for="content">评论内容:</label>
                    <textarea id="content" placeholder="请输入您的评论"></textarea>
                </div>
                <div>
                    <label for="parent_id">回复评论ID (可选):</label>
                    <input type="number" id="parent_id" placeholder="要回复的评论ID">
                </div>
                <button id="submit-comment">提交评论</button>
            </div>
        </div>

        <div class="container">
            <h2>评论列表</h2>
            <div id="message"></div>
            <div id="comments-container">
                <div class="loading">请输入文章标识并点击"获取评论"按钮加载评论</div>
            </div>
        </div>
    </div>

    <script>
        // API基础URL - 根据实际部署情况调整
        const API_BASE = 'http://localhost:17171/api/comments';

        // 获取评论
        document.getElementById('fetch-comments').addEventListener('click', async () => {
            const postSlug = document.getElementById('post_slug').value;
            const page = document.getElementById('page').value;
            const limit = document.getElementById('limit').value;
            const nested = document.getElementById('nested').checked;

            if (!postSlug) {
                showMessage('请输入文章标识', 'error');
                return;
            }

            try {
                showLoading();
                const response = await fetch(`${API_BASE}?post_slug=${encodeURIComponent(postSlug)}&page=${page}&limit=${limit}&nested=${nested}`);
                const data = await response.json();
                
                if (response.ok) {
                    console.log(data);
                    renderComments(data);
                } else {
                    showMessage(`获取评论失败: ${data.error || '未知错误'}`, 'error');
                }
            } catch (error) {
                showMessage(`网络错误: ${error.message}`, 'error');
            }
        });

        // 提交评论
        document.getElementById('submit-comment').addEventListener('click', async () => {
            const parentIdValue = document.getElementById('parent_id').value;
            const postData = {
                post_slug: document.getElementById('new_post_slug').value,
                author: document.getElementById('author').value,
                email: document.getElementById('email').value,
                url: document.getElementById('url').value || undefined,
                content: document.getElementById('content').value,
                parent_id: parentIdValue ? parseInt(parentIdValue, 10) : null
            };

            // 验证必填字段
            if (!postData.post_slug || !postData.author || !postData.email || !postData.content) {
                showMessage('请填写所有必填字段', 'error');
                return;
            }
            
            // 验证 parent_id 是否为有效数字（如果填写了的话）
            if (parentIdValue && (isNaN(postData.parent_id) || postData.parent_id <= 0)) {
                showMessage('回复评论ID必须是有效的正整数', 'error');
                return;
            }

            try {
                const response = await fetch(API_BASE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(postData)
                });

                const data = await response.json();
                
                if (response.ok) {
                    showMessage('评论提交成功！', 'success');
                    // 清空表单（保留post_slug）
                    document.getElementById('author').value = '';
                    document.getElementById('email').value = '';
                    document.getElementById('url').value = '';
                    document.getElementById('content').value = '';
                    document.getElementById('parent_id').value = '';
                } else {
                    showMessage(`提交失败: ${data.error || '未知错误'}`, 'error');
                }
            } catch (error) {
                showMessage(`网络错误: ${error.message}`, 'error');
            }
        });

        // 显示消息
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.innerHTML = `<div class="${type}">${text}</div>`;
            
            // 3秒后自动清除消息
            setTimeout(() => {
                messageEl.innerHTML = '';
            }, 3000);
        }

        // 显示加载状态
        function showLoading() {
            document.getElementById('comments-container').innerHTML = '<div class="loading">正在加载评论...</div>';
        }

        // 渲染评论
        function renderComments(data) {
            const container = document.getElementById('comments-container');
            
            // 根据实际数据结构调整判断条件
            if (!data.data || data.data.length === 0) {
                container.innerHTML = '<div>暂无评论</div>';
                return;
            }

            let html = '';
            
            // 递归渲染评论和回复
            function renderComment(comment, isReply = false) {
                const repliesHtml = comment.replies && comment.replies.length > 0 
                    ? `
                        <div class="replies" style="margin-left: 20px; border-left: 2px solid #eee; padding-left: 10px;">
                            ${comment.replies.map(reply => renderComment(reply, true)).join('')}
                        </div>
                    ` 
                    : '';
                
                return `
                    <div class="comment" style="${isReply ? 'margin-top: 10px;' : ''}">
                        <div class="comment-header">
                            <span class="comment-author">${escapeHtml(comment.author)}</span>
                            <span>${formatDate(comment.pubDate)}</span>
                        </div>
                        <div class="comment-content">${escapeHtml(comment.contentText)}</div>
                        ${repliesHtml}
                    </div>
                `;
            }

            // 渲染所有顶层评论
            html = data.data.map(comment => renderComment(comment)).join('');

            container.innerHTML = html;
        }

        // 简单的HTML转义函数
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }
    </script>
</body>
</html>